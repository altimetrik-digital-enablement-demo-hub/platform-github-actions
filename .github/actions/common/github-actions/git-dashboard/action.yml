name: "Summarize Report"
description: "Summarize a tool's report and write to GITHUB_STEP_SUMMARY in a clean markdown format"

inputs:
  tool:
    description: "Tool name (e.g., Trivy, CodeQL, Docker)"
    required: true

  report:
    description: "Path to the report file (e.g., report.txt)"
    required: true
  
  format:
    required: false
    description: 'Report format (e.g. text, sarif, eslint-json, jest-json)'
    default: 'auto'

  title:
    description: "Optional title for the summary section"
    required: false
    default: "Scan Summary"

  max-lines:
    description: "Number of lines from the report to include"
    required: false
    default: "100"
  
  fail-on-keywords:
    description: "Comma-separated list of keywords. If any is found in report, step fails"
    required: false
    default: ""
  
  threshold-checks:
    description: "Newline-separated thresholds. Format: Metric OP Value (e.g., Code Quality < 6)"
    required: false
    default: ""

runs:
  using: 'composite'
  steps:
    - name: Summarize Report
      shell: bash
      run: |
        set +e

        TOOL="${{ inputs.tool }}"
        REPORT="${{ inputs.report }}"
        FORMAT="${{ inputs.format }}"
        TITLE="${{ inputs.title }}"
        MAX_LINES="${{ inputs['max-lines'] }}"
        FAIL_KEYWORDS="${{ inputs['fail-on-keywords'] }}"
        THRESHOLD_CHECKS="${{ inputs['threshold-checks'] }}"

        echo "## üß© $TOOL - $TITLE" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"

        if [[ ! -f "$REPORT" ]]; then
          echo "‚ùå Report file not found: $REPORT" >> "$GITHUB_STEP_SUMMARY"
          exit 0
        fi

        # Auto-detect format
        if [[ "$FORMAT" == "auto" ]]; then
          EXT="${REPORT##*.}"
          case "$EXT" in
            json) FORMAT="json" ;;
            sarif) FORMAT="sarif" ;;
            xml) FORMAT="xml" ;;
            *) FORMAT="text" ;;
          esac
        fi

        echo "üîç Tool: $TOOL" >> "$GITHUB_STEP_SUMMARY"
        echo "üìÑ Report: $REPORT" >> "$GITHUB_STEP_SUMMARY"
        echo "üìù Title: $TITLE" >> "$GITHUB_STEP_SUMMARY"
        echo "üîé Format: $FORMAT" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"

        FAIL_FOUND=0

        #########################
        # Format-specific summary
        #########################

        case "$FORMAT" in
          sarif)
            echo "| Severity | Count |" >> "$GITHUB_STEP_SUMMARY"
            echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
            for level in error warning note; do
              COUNT=$(jq "[.runs[].results[] | select(.level == \"$level\")] | length" "$REPORT" 2>/dev/null || echo 0)
              echo "| $level | $COUNT |" >> "$GITHUB_STEP_SUMMARY"
            done
            ;;
          json)
            echo "| Key | Value |" >> "$GITHUB_STEP_SUMMARY"
            echo "|-----|-------|" >> "$GITHUB_STEP_SUMMARY"
            jq -r 'to_entries[] | select(.value|type != "object") | "| \(.key) | \(.value) |"' "$REPORT" 2>/dev/null | head -n "$MAX_LINES" >> "$GITHUB_STEP_SUMMARY"
            ;;
          xml)
            echo "| Tag | Count |" >> "$GITHUB_STEP_SUMMARY"
            echo "|-----|-------|" >> "$GITHUB_STEP_SUMMARY"
            for tag in testsuite testcase error failure skipped; do
              COUNT=$(grep -c "<$tag" "$REPORT" || true)
              echo "| <$tag> | $COUNT |" >> "$GITHUB_STEP_SUMMARY"
            done
            ;;
          text|*)
            # Pattern Matches
            echo "### üîé Pattern Matches" >> "$GITHUB_STEP_SUMMARY"
            echo "| Pattern | Match |" >> "$GITHUB_STEP_SUMMARY"
            echo "|---------|--------|" >> "$GITHUB_STEP_SUMMARY"

            MATCH=$(grep -Eo "Ran [0-9]+ test(s)? in [0-9\.]+s" "$REPORT" | head -n 1)
            [[ -n "$MATCH" ]] && echo "| Ran Tests | $MATCH |" >> "$GITHUB_STEP_SUMMARY"

            MATCH=$(grep -Eo "rated at [0-9\.]+/10" "$REPORT" | head -n 1)
            [[ -n "$MATCH" ]] && echo "| Code Quality | $MATCH |" >> "$GITHUB_STEP_SUMMARY"

            MATCHES=$(grep -Eo "Total: [0-9]+ \(HIGH: [0-9]+, CRITICAL: [0-9]+\)" "$REPORT" | head -n 2)
            while IFS= read -r line; do
              echo "| Vulnerabilities | $line |" >> "$GITHUB_STEP_SUMMARY"
            done <<< "$MATCHES"

            # Keywords table only if non-zero
            KEYWORDS=(ERROR FAILED FAIL Traceback Exception)
            KEYWORD_TABLE=""
            NONZERO_FOUND=0
            for word in "${KEYWORDS[@]}"; do
              COUNT=$(grep -ic "$word" "$REPORT" || true)
              [[ "$COUNT" -gt 0 ]] && NONZERO_FOUND=1
              KEYWORD_TABLE+=$'\n'"| $word | $COUNT |"
            done
            if [[ "$NONZERO_FOUND" -eq 1 ]]; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "### ‚ùó Keyword Matches" >> "$GITHUB_STEP_SUMMARY"
              echo "| Keyword | Count |" >> "$GITHUB_STEP_SUMMARY"
              echo "|---------|-------|" >> "$GITHUB_STEP_SUMMARY"
              echo "$KEYWORD_TABLE" >> "$GITHUB_STEP_SUMMARY"
              FAIL_FOUND=1
            fi
            ;;
        esac

        #############################
        # üö® Threshold Validation
        #############################

        if [[ -n "$THRESHOLD_CHECKS" ]]; then
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### üö® Threshold Checks" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Operator | Value | Actual | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|----------|-------|--------|--------|" >> "$GITHUB_STEP_SUMMARY"

          IFS=',' read -ra THRESHOLDS <<< "$THRESHOLD_CHECKS"
          for threshold in "${THRESHOLDS[@]}"; do
            METRIC=$(echo "$threshold" | cut -d':' -f1)
            OPERATOR=$(echo "$threshold" | cut -d':' -f2)
            VALUE=$(echo "$threshold" | cut -d':' -f3)

            # Find actual value from report
            ACTUAL="N/A"
            case "$METRIC" in
              "Code Quality")
                ACTUAL=$(grep -Eo "rated at [0-9\.]+/10" "$REPORT" | grep -Eo "[0-9\.]+(?=/10)" | head -n 1)
                ;;
              "CRITICAL")
                ACTUAL=$(grep -Eo "CRITICAL: [0-9]+" "$REPORT" | grep -Eo "[0-9]+" | head -n 1)
                ;;
              "HIGH")
                ACTUAL=$(grep -Eo "HIGH: [0-9]+" "$REPORT" | grep -Eo "[0-9]+" | head -n 1)
                ;;
              *)
                ACTUAL="N/A"
                ;;
            esac

            PASS="‚úÖ"
            if [[ "$ACTUAL" != "N/A" ]]; then
              if ! awk "BEGIN {exit !($ACTUAL $OPERATOR $VALUE)}"; then
                PASS="‚ùå"
                FAIL_FOUND=1
              fi
            else
              PASS="‚ùå"
              FAIL_FOUND=1
            fi

            echo "| $METRIC | $OPERATOR | $VALUE | ${ACTUAL:-N/A} | $PASS |" >> "$GITHUB_STEP_SUMMARY"
          done
        fi

        ####################
        # Raw Report Section
        ####################

        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "<details><summary>üìÑ Raw Report (Top $MAX_LINES lines)</summary>" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo '```' >> "$GITHUB_STEP_SUMMARY"
        head -n "$MAX_LINES" "$REPORT" >> "$GITHUB_STEP_SUMMARY"
        echo '```' >> "$GITHUB_STEP_SUMMARY"
        echo "</details>" >> "$GITHUB_STEP_SUMMARY"

        ####################
        # Final fail logic
        ####################

        if [[ "$FAIL_FOUND" -eq 1 ]]; then
          echo "‚ùå Threshold or pattern checks failed"
          exit 1
        fi

        exit 0