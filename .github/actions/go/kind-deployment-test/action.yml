name: Simple Kind Cluster Test
description: Create a Kind cluster and test basic functionality

inputs:
  app-name:
    description: 'Application name for cluster naming'
    required: true
    default: 'test-app'
  registry:
    required: true
    description: 'Container registry URL (e.g., ghcr.io, AWS ECR)'
    default: 'ghcr.io'
  image-tag:
    description: 'Docker image tag to deploy'
    required: true
    default: 'latest'
  chart-path:
    description: 'Path to the Helm chart for deployment'
    required: false
    default: './deploy/helm'
  namespace:
    description: 'Kubernetes namespace'
    required: false
    default: 'default'

runs:
  using: 'composite'
  steps:
    - name: Create Kind cluster
      uses: helm/kind-action@v1
      with:
        cluster_name: ${{ inputs.app-name }}-test
        wait: 60s

    - name: Test cluster
      shell: bash
      run: |
        echo "ğŸ¯ Testing Kind cluster..."
        # Test cluster is working
        kubectl cluster-info
        kubectl get nodes
        echo "âœ… Cluster is ready!"

    - name: Deploy app with Helm
      uses: altimetrik-digital-enablement-demo-hub/platform-github-actions/.github/actions/common/helm-deployment@v1
      with: 
        app-name: ${{ inputs.app-name }}
        chart-path: ${{ inputs.chart-path }}
        namespace: ${{ inputs.namespace }}
        repository: ${{ inputs.registry }}/${{ inputs.app-name }}
        tag: ${{ inputs.image-tag }}
        args: >-
          --atomic
          --wait
          --timeout 2m 
          --wait-for-jobs
          --debug

    - name: Verify deployment
      shell: bash
      run: |
        echo "ğŸ” Verifying deployment..."
        
        # Wait for deployment to be ready
        echo "â³ Waiting for deployment rollout..."
        kubectl rollout status deployment/${{ inputs.app-name }} -n ${{ inputs.namespace }} --timeout=2m || {
          echo "âŒ Deployment failed to roll out!"
          echo "ğŸ” Debugging deployment issues:"
          kubectl describe deployment ${{ inputs.app-name }} -n ${{ inputs.namespace }}
          echo "ï¿½ï¿½ Deployment events:"
          kubectl get events -n ${{ inputs.namespace }} --sort-by='.lastTimestamp'
          exit 1
        }
        
        # Get deployment status
        echo "ï¿½ï¿½ Deployment status:"
        kubectl get deployment -n ${{ inputs.namespace }} -l app.kubernetes.io/name=${{ inputs.app-name }} -o wide
        
        # Get pods with their images
        echo "ğŸ“¦ Pod details:"
        kubectl get pods -n ${{ inputs.namespace }} -o custom-columns=NAME:.metadata.name,STATUS:.status.phase,IMAGE:.spec.containers[0].image,READY:.status.containerStatuses[0].ready
        
        # Check if pods are stuck
        if kubectl get pods -n ${{ inputs.namespace }} | grep -q "Pending\|Error\|CrashLoopBackOff"; then
          echo "ğŸ” Debugging pod issues:"
          kubectl describe pods -n ${{ inputs.namespace }}
          echo "ï¿½ï¿½ Pod events:"
          kubectl get events -n ${{ inputs.namespace }} --sort-by='.lastTimestamp' | grep -E "(sample-go|Failed|Error)"
          echo "ï¿½ï¿½ Image pull issues:"
          kubectl get pods -n ${{ inputs.namespace }} -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.containerStatuses[0].state.waiting.reason}{"\t"}{.status.containerStatuses[0].state.waiting.message}{"\n"}{end}'
          exit 1
        fi
        
        # Get services
        echo "ï¿½`ï¿½ Service details:"
        kubectl get services -n ${{ inputs.namespace }}
      
        echo "âœ… Deployment verification complete!"

    - name: Cleanup test resources
      shell: bash
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up test resources..."
        kubectl delete namespace ${{ inputs.namespace }} --ignore-not-found=true || true