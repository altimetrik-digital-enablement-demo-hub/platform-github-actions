name: Go Dev Build Pipeline

on:
  workflow_call:
    inputs:
      app-name:
        required: true
        type: string

jobs:
  setup:
    uses: osru-leu/platform-github-actions/.github/workflows/setup-image-tag.yml@feature/workflows

  lint:
    uses: osru-leu/platform-github-actions/.github/workflows/lint-go.yml@feature/workflows
    with:
      language: go

  test:
    uses: osru-leu/platform-github-actions/.github/workflows/test-go.yml@feature/workflows
    needs: lint
    with:
      language: go

  build:
    uses: osru-leu/platform-github-actions/.github/workflows/build-go.yml@feature/workflows
    needs: test
    with:
      language: go
      app-name: ${{ inputs.app-name }}

  package:
    uses: osru-leu/platform-github-actions/.github/workflows/package-go.yml@feature/workflows
    needs: [build, setup]
    with:
      language: go
      app-name: ${{ inputs.app-name }}
      image-tag: ${{ needs.setup.outputs.image-tag }}

  security:
    uses: osru-leu/platform-github-actions/.github/workflows/security-scan.yml@feature/workflows
    needs: [package, setup]
    with:
      image-name: ${{ inputs.app-name }}
      image-tag: ${{ needs.setup.outputs.image-tag }}
      languages: go

  deploy-k8s:
    uses: osru-leu/platform-github-actions/.github/workflows/deploy.yml@feature/workflows
    needs: security
    with:
      app-name: ${{ inputs.app-name }}
      environment: dev
      image-tag: ${{ needs.setup.outputs.image-tag }}

  deploy-aws:
    uses: osru-leu/platform-github-actions/.github/workflows/deploy-aws.yml@feature/workflows
    needs: security
    with:
      app-name: ${{ inputs.app-name }}
      environment: dev
      image-tag: ${{ needs.setup.outputs.image-tag }} 